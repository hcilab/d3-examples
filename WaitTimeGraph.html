<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hospital Wait Times</title>
  </head>
  <body>
		<script src="d3.js"></script>
		<script src="d3tip.js"></script>
  </body>
	<style>
		.axis path,
		.axis line {
			fill: none;
			stroke: rgba(0, 0, 0, 0.1);
			shape-rendering: crispEdges;
		}
		.axisLine {
			fill: none;
			shape-rendering: crispEdges;
			stroke: rgba(0, 0, 0, 0.5);
			stroke-width: 2px;
		}
		.dot,
		.dot2,
		.dot3,
		.dot4,
		.dot5,
		.dot6,
		.dot7,
		.dot8{
			fill-opacity: 0.5;
		}
		.button1,
		.button2
		{
			fill-opacity: 1.0;
		}
	</style>
	<script>
		//Instantiate data arrays
		var qehData = new Array();
		var pchData = new Array();
		for(var i = 0; i < 4; i++){
			qehData[i] = new Array();
			pchData[i] = new Array();
		}

		//Define margin
		var margin = { top: 50, right: 300, bottom: 50, left: 75 },
				outerWidth = 1600,
				outerHeight = 800,
				width = outerWidth - margin.left - margin.right,
				height = outerHeight - margin.top - margin.bottom;

		//Set scales, formatting, axes,etc.
		var x = d3.time.scale()
				.range([0, width]).nice();
		var y = d3.scale.linear()
				.range([height, 0]).nice();
		var y1 = d3.scale.linear()
				.range([height, 0]).nice();
		var y2 = d3.scale.linear()
				.range([height, 0]).nice();
		var xCat = "Date",
				yCat = "Wait Time (hrs)";
		var timeFormat = d3.time.format("%x %X");
		var valueline = d3.svg.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y1(d.temp); });
		var valueline2 = d3.svg.line()
		.x(function(d) { return x(d.date); })
		.y(function(d) { return y2(d.precip); });

		//Set data flags
		var pchMU = false;
		var pchU = false;
		var pchLU = false;
		var pchA = false;
		var qehMU = false;
		var qehU = false;
		var qehLU = false;
		var qehA = false;
		var showTemp = false;
		var showPrecip = false;


	//Read data
		d3.csv("waittimes.csv", function(error, data){
			if(error) throw error;

			//Manage data
			data.forEach(function(d){
				var hospital = d.hospital;
				var measureName = d.measurename;
				var measureVar = d.measurevariant;
				if(hospital == "qeh"){
					if(measureName == "mosturgent"){
						if(measureVar == "number"){
							qehData[0].push(d);
						}
						else if(measureVar == "wait"){
							qehData[0][qehData[0].length-1].measureconverted = d.measureconverted;
						}
					}
					else 	if(measureName == "urgent"){
						if(measureVar == "number"){
							qehData[1].push(d);
						}
						else if(measureVar == "wait"){
							qehData[1][qehData[1].length-1].measureconverted = d.measureconverted;
						}
					}
					else 	if(measureName == "lessurgent"){
						if(measureVar == "number"){
							qehData[2].push(d);
						}
						else if(measureVar == "wait"){
							qehData[2][qehData[2].length-1].measureconverted = d.measureconverted;
						}
					}
					else 	if(measureName == "treating"){
						if(measureVar == "number"){
							qehData[3].push(d);
						}
					}
				}
				else if(hospital == "pch"){
					if(measureName == "mosturgent"){
						if(measureVar == "number"){
							pchData[0].push(d);
						}
						else if(measureVar == "wait"){
							pchData[0][pchData[0].length-1].measureconverted = d.measureconverted;
						}
					}
					else 	if(measureName == "urgent"){
						if(measureVar == "number"){
							pchData[1].push(d);
						}
						else if(measureVar == "wait"){
							pchData[1][pchData[1].length-1].measureconverted = d.measureconverted;
						}
					}
					else 	if(measureName == "lessurgent"){
						if(measureVar == "number"){
							pchData[2].push(d);
						}
						else if(measureVar == "wait"){
							pchData[2][pchData[2].length-1].measureconverted = d.measureconverted;
						}
					}
					else  if(measureName == "treating"){
						if(measureVar == "number"){
							pchData[3].push(d);
						}
					}
				}
			});

			var temp = [[],[],[],[]];
			for(var i = 0; i < 4; i++){
				var count = 0;
				var waitTotal = 0;
				var numberTotal = 0;
				var index = 0;
				var day = timeFormat.parse(pchData[i][0].sampletime);
				for(var j = 0; j < pchData[i].length; j++){
					var newDay = timeFormat.parse(pchData[i][j].sampletime);
					if(newDay.getDate() == day.getDate()){
						waitTotal += +pchData[i][j].measureconverted;
						numberTotal += +pchData[i][j].measurevalue;
						count++;
					}
					else{
						var wait = waitTotal/count;
						var number = numberTotal/count;
						var d = new Date(day.getFullYear(), day.getMonth(), day.getDate());
						temp[i][index] = {date:d, wait:wait, number:number};
						day = newDay;
						count = 0;
						waitTotal = 0;
						numberTotal = 0;
						index++;
					}
				}
			}
			pchData = temp;

			temp = [[],[],[],[]];
			for(var i = 0; i < 4; i++){
				var count = 0;
				var waitTotal = 0;
				var numberTotal = 0;
				var index = 0;
				var day = timeFormat.parse(qehData[i][0].sampletime);
				for(var j = 0; j < qehData[i].length; j++){
					var newDay = timeFormat.parse(qehData[i][j].sampletime);
					if(newDay.getDate() == day.getDate()){
						waitTotal += +qehData[i][j].measureconverted;
						numberTotal += +qehData[i][j].measurevalue;
						count++;
					}
					else{
						var wait = waitTotal/count;
						var number = numberTotal/count;
						temp[i][index] = {date:day, wait:wait, number:number};
						day = newDay;
						count = 0;
						waitTotal = 0;
						numberTotal = 0;
						index++;
					}
				}
			}
			qehData = temp;

			var updateDraw = function(){
				x.domain(d3.extent(qehData[2], function(d) { return d.date; }));
				y.domain([0, 7]);

				var xAxis = d3.svg.axis()
						.scale(x)
						.orient("bottom")
						.tickSize(-height);

				var yAxis = d3.svg.axis()
						.scale(y)
						.orient("left")
						.tickSize(-width);

				var yAxisRight = d3.svg.axis().scale(y1)
				    .orient("right");

				var svg = d3.select("body")
			    .append("svg")
			      .attr("width", outerWidth)
			      .attr("height", outerHeight)
			    .append("g")
			      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				svg.append("g")
					.append("text")
						.attr("x", width/2 - 120)
						.attr("y", -10)
						.style("text-anchor", "center")
						.style("font-size", 24)
						.style("font-weight", "bold")
						.text("Hospital Wait Times in PEI");

				//PCH Legend
				svg.append("text")
						.text("PCH")
						.attr("x", width + 130)
						.attr("y", -20)
						.style("text-anchor", "left")
						.style("font-size", 22);

				svg.append("g")
					.append("rect")
						.attr("width", 250)
						.attr("height",	200)
						.attr("x", width + 30)
						.attr("y", -10)
						.attr("fill", "white")
						.attr("stroke", "black");

				svg.append("text")
						.text("Most Urgent: ")
						.attr("x", width + 40)
						.attr("y", 10)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("circle")
						.attr("class", "dot")
						.attr("cx", width + 150)
						.attr("cy", 5)
						.attr("r", 10)
						.attr("fill", "red")
						.on("mouseover", function(){
							d3.selectAll(".dot")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							pchMU = !pchMU;
							updateDraw();
						});

				svg.append("text")
						.text("Urgent: ")
						.attr("x", width + 40)
						.attr("y", 50)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("circle")
						.attr("class", "dot2")
						.attr("cx", width + 150)
						.attr("cy", 45)
						.attr("r", 10)
						.attr("fill", "orange")
						.on("mouseover", function(){
							d3.selectAll(".dot2")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot2")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							pchU = !pchU;
							updateDraw();
						});

				svg.append("text")
						.text("Less Urgent: ")
						.attr("x", width + 40)
						.attr("y", 90)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("circle")
						.attr("class", "dot3")
						.attr("cx", width + 150)
						.attr("cy", 85)
						.attr("r", 10)
						.attr("fill", "green")
						.on("mouseover", function(){
							d3.selectAll(".dot3")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot3")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							pchLU = !pchLU;
							updateDraw();
						});

				svg.append("text")
						.text("Average: ")
						.attr("x", width + 40)
						.attr("y", 130)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("circle")
						.attr("class", "dot4")
						.attr("cx", width + 150)
						.attr("cy", 125)
						.attr("r", 10)
						.attr("fill", "blue")
						.on("mouseover", function(){
							d3.selectAll(".dot4")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot4")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							pchA = !pchA;
							updateDraw();
						});

				svg.append("text")
						.text("Size: ")
						.attr("x", width + 40)
						.attr("y", 170)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("text")
						.text("Number of People")
						.attr("x", width + 80)
						.attr("y", 170)
						.style("text-anchor", "left")
						.style("font-size", 16);

				//QEH Legend
				svg.append("text")
						.text("QEH")
						.attr("x", width + 130)
						.attr("y", -20 + 280)
						.style("text-anchor", "left")
						.style("font-size", 22);

				svg.append("g")
					.append("rect")
						.attr("width", 250)
						.attr("height",	200)
						.attr("x", width + 30)
						.attr("y", -10 + 280)
						.attr("fill", "white")
						.attr("stroke", "black");

				svg.append("text")
						.text("Most Urgent: ")
						.attr("x", width + 40)
						.attr("y", 10 + 280)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("rect")
						.attr("class", "dot5")
						.attr("width", 15)
						.attr("height", 15)
						.attr("x", width + 140)
						.attr("y", 5 + 275)
						.attr("fill", "red")
						.on("mouseover", function(){
							d3.selectAll(".dot5")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot5")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							qehMU = !qehMU;
							updateDraw();
						});

				svg.append("text")
						.text("Urgent: ")
						.attr("x", width + 40)
						.attr("y", 50 + 280)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("rect")
						.attr("class", "dot6")
						.attr("width", 15)
						.attr("height", 15)
						.attr("x", width + 140)
						.attr("y", 45 + 275)
						.attr("fill", "orange")
						.on("mouseover", function(){
							d3.selectAll(".dot6")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot6")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							qehU = !qehU;
							updateDraw();
						});

				svg.append("text")
						.text("Less Urgent: ")
						.attr("x", width + 40)
						.attr("y", 90 + 280)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("rect")
						.attr("class", "dot7")
						.attr("width", 15)
						.attr("height", 15)
						.attr("x", width + 140)
						.attr("y", 85 + 275)
						.attr("fill", "green")
						.on("mouseover", function(){
							d3.selectAll(".dot7")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot7")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							qehLU = !qehLU;
							updateDraw();
						});

				svg.append("text")
						.text("Average: ")
						.attr("x", width + 40)
						.attr("y", 130 + 280)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("rect")
						.attr("class", "dot8")
						.attr("width", 15)
						.attr("height", 15)
						.attr("x", width + 140)
						.attr("y", 130 + 270)
						.attr("fill", "blue")
						.on("mouseover", function(){
							d3.selectAll(".dot8")
								.style("fill-opacity", 1);
						})
						.on("mouseout", function(){
							d3.selectAll(".dot8")
								.style("fill-opacity", 0.5);
						})
						.on("click", function(){
							d3.selectAll("svg").remove();
							qehA = !qehA;
							updateDraw();
						});

				svg.append("text")
						.text("Size: ")
						.attr("x", width + 40)
						.attr("y", 170 + 280)
						.style("text-anchor", "left")
						.style("font-size", 16);

				svg.append("text")
						.text("Number of People")
						.attr("x", width + 80)
						.attr("y", 170 + 280)
						.style("text-anchor", "left")
						.style("font-size", 16);

				//Add Buttons
				svg.append("rect")
					.attr("class", "button1")
					.attr("width", 140)
					.attr("height", 30)
					.attr("x", width + 50)
					.attr("y", 510)
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("fill", "#EEAA66")
					.on('click', function() {
						showTemp = !showTemp;
						d3.selectAll("svg").remove();
						updateDraw();
					})
					.on("mouseover", function(){
						d3.select(".button1")
							.style("opacity", 0.5);
					})
					.on("mouseout", function(){
						d3.select(".button1")
							.style("opacity", 1.0);
					});

				svg.append("text")
					.attr("class", "button1")
					.attr("x", width + 60)
					.attr("y", 530)
					.text("Mean Temperature")
					.on('click', function() {
						showTemp = !showTemp;
						d3.selectAll("svg").remove();
						updateDraw();
					})
					.on("mouseover", function(){
						d3.select(".button1")
							.style("opacity", 0.5);
					})
					.on("mouseout", function(){
						d3.select(".button1")
							.style("opacity", 1.0);
					});

				svg.append("rect")
					.attr("class", "button2")
					.attr("width", 140)
					.attr("height", 30)
					.attr("x", width + 50)
					.attr("y", 560)
					.attr("rx", 10)
					.attr("ry", 10)
					.attr("fill", "#88CCEE")
					.on('click', function() {
						showPrecip = !showPrecip;
						d3.selectAll("svg").remove();
						updateDraw();
					})
					.on("mouseover", function(){
						d3.select(".button2")
							.style("opacity", 0.5);
					})
					.on("mouseout", function(){
						d3.select(".button2")
							.style("opacity", 1.0);
					});

				svg.append("text")
					.attr("class", "button2")
					.attr("x", width + 60)
					.attr("y", 580)
					.text("Total Precipitation")
					.on('click', function() {
						showPrecip = !showPrecip;
						d3.selectAll("svg").remove();
						updateDraw();
					})
					.on("mouseover", function(){
						d3.select(".button2")
							.style("opacity", 0.5);
					})
					.on("mouseout", function(){
						d3.select(".button2")
							.style("opacity", 1.0);
					});

				svg.append("g")
						.classed("x axis", true)
						.attr("transform", "translate(0," + height + ")")
						.call(xAxis)
					.append("text")
						.classed("label", true)
						.attr("x", width)
						.attr("y", margin.bottom - 10)
						.style("text-anchor", "end")
						.text(xCat);

				svg.append("g")
			      .classed("y axis", true)
			      .call(yAxis)
			    .append("text")
			      .classed("label", true)
			      .attr("transform", "rotate(-90)")
			      .attr("y", -margin.left)
			      .attr("dy", ".71em")
			      .style("text-anchor", "end")
			      .text(yCat);


				//Add Data Shape Elements

				//PCH Elements
					if(pchLU){
						svg.selectAll(".dot3")
									.data(pchData[2])
								.enter().append("circle")
									.classed("dot3", true)
									.attr("transform", function(d){
										if(d.wait != 0) return "translate(" + x(d.date) + "," + y(d.wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("r", function(d){ return Math.sqrt(d.number*20); })
									.attr("fill", "green");
					}
					if(pchU){
						svg.selectAll(".dot2")
									.data(pchData[1])
								.enter().append("circle")
									.classed("dot2", true)
									.attr("transform", function(d){
										if(d.wait != 0) return "translate(" + x(d.date) + "," + y(d.wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("r", function(d){ return Math.sqrt(d.number*20); })
									.attr("fill", "orange");
					}
					if(pchMU){
						svg.selectAll(".dot")
									.data(pchData[0])
								.enter().append("circle")
									.classed("dot", true)
									.attr("transform", function(d){
										if(d.wait != 0) return "translate(" + x(d.date) + "," + y(d.wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("r", function(d){ return Math.sqrt(d.number*20); })
									.attr("fill", "red");
					}
					if(pchA){
						svg.selectAll(".dot4")
									.data(pchData[0])
								.enter().append("circle")
									.classed("dot4", true)
									.attr("transform", function(d,i){
										var wait = (pchData[0][i].wait + pchData[1][i].wait + pchData[2][i].wait)/3;
										if(wait != 0) return "translate(" + x(d.date) + "," + y(wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("r", function(d,i){
										return Math.sqrt((20*(pchData[0][i].number + pchData[1][i].number + pchData[2][i].number)/3));
									})
									.attr("fill", "blue");
					}

					//QEH Elements
					if(qehLU){
						svg.selectAll(".dot7")
									.data(qehData[2])
								.enter().append("rect")
									.classed("dot7", true)
									.attr("transform", function(d){
										if(d.wait != 0)	return "translate(" + (x(d.date) - ((Math.sqrt(d.number*40))/2)) + "," + y(d.wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("width", function(d){ return Math.sqrt(d.number*40); })
									.attr("height", function(d){ return Math.sqrt(d.number*40); })
									.attr("fill", "green");
					}
					if(qehU){
						svg.selectAll(".dot6")
									.data(qehData[1])
								.enter().append("rect")
									.classed("dot6", true)
									.attr("transform", function(d){
										if(d.wait != 0)	return "translate(" + (x(d.date) - ((Math.sqrt(d.number*40))/2)) + "," + y(d.wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("width", function(d){ return Math.sqrt(d.number*40); })
									.attr("height", function(d){ return Math.sqrt(d.number*40); })
									.attr("fill", "orange");
					}
					if(qehMU){
						svg.selectAll(".dot5")
									.data(qehData[0])
								.enter().append("rect")
									.classed("dot5", true)
									.attr("transform", function(d){
										if(d.wait != 0)	return "translate(" + (x(d.date) - ((Math.sqrt(d.number*40))/2)) + "," + y(d.wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("width", function(d){ return Math.sqrt(d.number*40); })
									.attr("height", function(d){ return Math.sqrt(d.number*40); })
									.attr("fill", "red");
					}
					if(qehA){
						svg.selectAll(".dot8")
									.data(qehData[0])
								.enter().append("rect")
									.classed("dot8", true)
									.attr("transform", function(d,i){
										var wait = (qehData[0][i].wait + qehData[1][i].wait + qehData[2][i].wait)/3;
										if(wait != 0) return "translate(" + (x(d.date) - ((Math.sqrt(d.number*40))/2)) + "," + y(wait) + ")";
										else return "translate(" + -100 + "," + -100 + ")";
									})
									.attr("width", function(d,i){
										return Math.sqrt(40*(qehData[0][i].number + qehData[1][i].number + qehData[2][i].number)/3);
									})
									.attr("height", function(d,i){
										return Math.sqrt(40*(qehData[0][i].number + qehData[1][i].number + qehData[2][i].number)/3);
									})
									.attr("fill", "blue");
					}

					d3.csv("PEIWeatherData.csv", function(error, data2){
						if(error) throw error;
						var timeFormat2 = d3.time.format("%x");
						data2.forEach(function(d){
							d.date = timeFormat2.parse(d.date);
							d.temp = +d.temp;
							d.precip = +d.precip;
						});
						y1.domain([-23, 25]);
						y2.domain([0, 66]);
						if(showTemp){
							svg.append("path")
								.attr("class", "weatherLine")
								.classed("weatherLine", true)
								.attr("d", valueline(data2))
								.style("stroke", "#EEAA66")
								.attr("fill", "none");
						}
						if(showPrecip){
							svg.append("path")
								.attr("class", "weatherLine")
								.classed("weatherLine", true)
								.attr("d", valueline2(data2))
								.style("stroke", "#88CCEE")
								.attr("fill", "none");
						}
					});

			}

			updateDraw();

		});

	</script>
</html>
